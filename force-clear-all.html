<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ•°æ®å’Œç¼“å­˜</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
            transition: background 0.2s;
        }
        .button:hover {
            background: #0056CC;
        }
        .button.danger {
            background: #FF3B30;
        }
        .button.danger:hover {
            background: #D70015;
        }
        .button.success {
            background: #34C759;
        }
        .button.warning {
            background: #FF9500;
        }
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin: 16px 0;
        }
        .step h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
        }
        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            text-align: center;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ§¹ å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ•°æ®å’Œç¼“å­˜</h1>
        <p><strong>è¿™ä¸ªå·¥å…·å°†å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½å¯¼è‡´AIè¯†åˆ«ç»“æœæ˜¾ç¤ºçš„æ•°æ®æºã€‚</strong></p>
        
        <div id="status"></div>
        
        <div class="step">
            <h4>ğŸ¯ é—®é¢˜åˆ†æ</h4>
            <p>ä½ çœ‹åˆ°çš„AIè¯†åˆ«ç»“æœå¯èƒ½æ¥è‡ªä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š</p>
            <ul>
                <li><strong>æµè§ˆå™¨localStorage</strong>ï¼šä¿å­˜çš„å†å²æ‰“å¡æ•°æ®</li>
                <li><strong>æµè§ˆå™¨ç¼“å­˜</strong>ï¼šç¼“å­˜çš„é¡µé¢å’Œèµ„æº</li>
                <li><strong>Service Workerç¼“å­˜</strong>ï¼šPWAåº”ç”¨çš„ç¦»çº¿ç¼“å­˜</li>
                <li><strong>æµè§ˆå™¨ä¼šè¯å­˜å‚¨</strong>ï¼šä¸´æ—¶ä¼šè¯æ•°æ®</li>
                <li><strong>IndexedDB</strong>ï¼šæµè§ˆå™¨æ•°æ®åº“</li>
            </ul>
        </div>
        
        <div class="step">
            <h4>ğŸ”§ è§£å†³æ–¹æ¡ˆ</h4>
            <p>æˆ‘ä»¬å°†æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ¸…ç†æ“ä½œï¼š</p>
            <ol>
                <li>æ¸…ç†æ‰€æœ‰localStorageæ•°æ®</li>
                <li>æ¸…ç†æ‰€æœ‰sessionStorageæ•°æ®</li>
                <li>æ¸…ç†æ‰€æœ‰IndexedDBæ•°æ®</li>
                <li>æ³¨é”€Service Worker</li>
                <li>æ¸…ç†æ‰€æœ‰ç¼“å­˜</li>
                <li>å¼ºåˆ¶åˆ·æ–°åº”ç”¨</li>
            </ol>
        </div>
        
        <h3>ğŸš€ ä¸€é”®å½»åº•æ¸…ç†</h3>
        <button class="button danger" onclick="executeFullCleanup()">ğŸ§¹ æ‰§è¡Œå®Œæ•´æ¸…ç†æµç¨‹</button>
        <button class="button warning" onclick="manualSteps()">ğŸ“‹ æ˜¾ç¤ºæ‰‹åŠ¨æ¸…ç†æ­¥éª¤</button>
        
        <h3>ğŸ” å•ç‹¬æ“ä½œ</h3>
        <button class="button" onclick="clearLocalStorage()">æ¸…ç† localStorage</button>
        <button class="button" onclick="clearSessionStorage()">æ¸…ç† sessionStorage</button>
        <button class="button" onclick="clearIndexedDB()">æ¸…ç† IndexedDB</button>
        <button class="button" onclick="unregisterServiceWorker()">æ³¨é”€ Service Worker</button>
        <button class="button" onclick="clearAllCaches()">æ¸…ç†æ‰€æœ‰ç¼“å­˜</button>
        
        <h3>ğŸ”„ éªŒè¯å’Œé‡å¯</h3>
        <button class="button success" onclick="createFreshUser()">åˆ›å»ºå…¨æ–°ç”¨æˆ·</button>
        <button class="button success" onclick="openFreshApp()">æ‰“å¼€å…¨æ–°åº”ç”¨</button>
        
        <div id="countdown" class="countdown" style="display: none;"></div>
        <div id="manualSteps" style="display: none;">
            <div class="step">
                <h4>ğŸ“‹ æ‰‹åŠ¨æ¸…ç†æ­¥éª¤</h4>
                <ol>
                    <li><strong>æ‰“å¼€å¼€å‘è€…å·¥å…·</strong>ï¼šæŒ‰ F12 æˆ–å³é”®é€‰æ‹©"æ£€æŸ¥"</li>
                    <li><strong>è¿›å…¥Applicationæ ‡ç­¾</strong>ï¼šåœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰¾åˆ°Applicationé€‰é¡¹å¡</li>
                    <li><strong>æ¸…ç†Storage</strong>ï¼š
                        <ul>
                            <li>Local Storage â†’ åˆ é™¤æ‰€æœ‰æ¡ç›®</li>
                            <li>Session Storage â†’ åˆ é™¤æ‰€æœ‰æ¡ç›®</li>
                            <li>IndexedDB â†’ åˆ é™¤æ‰€æœ‰æ•°æ®åº“</li>
                        </ul>
                    </li>
                    <li><strong>æ¸…ç†Service Workers</strong>ï¼šåœ¨Service Workerséƒ¨åˆ†ç‚¹å‡»"Unregister"</li>
                    <li><strong>æ¸…ç†Cache Storage</strong>ï¼šåˆ é™¤æ‰€æœ‰ç¼“å­˜</li>
                    <li><strong>ç¡¬åˆ·æ–°</strong>ï¼šæŒ‰ Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°é¡µé¢</li>
                </ol>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <button class="button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logContainer" class="log-container"></div>
    </div>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#00ff00';
            
            logContainer.innerHTML += `<div style="color: ${color}">[${timestamp}] ${logCount}: ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            logCount = 0;
            log('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            log(`çŠ¶æ€: ${message}`, type);
        }
        
        function showCountdown(seconds, message) {
            const countdownDiv = document.getElementById('countdown');
            countdownDiv.style.display = 'block';
            
            let remaining = seconds;
            const interval = setInterval(() => {
                countdownDiv.innerHTML = `${message} ${remaining}ç§’`;
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(interval);
                    countdownDiv.style.display = 'none';
                }
            }, 1000);
        }
        
        async function clearLocalStorage() {
            log('å¼€å§‹æ¸…ç†localStorage...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                log(`å‘ç° ${keys.length} ä¸ªlocalStorageé”®`, 'info');
                
                keys.forEach(key => {
                    log(`åˆ é™¤localStorageé”®: ${key}`, 'info');
                    localStorage.removeItem(key);
                });
                
                log('localStorageæ¸…ç†å®Œæˆ', 'success');
                showStatus('âœ… localStorageå·²æ¸…ç†', 'success');
            } catch (error) {
                log(`æ¸…ç†localStorageå¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ localStorageæ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function clearSessionStorage() {
            log('å¼€å§‹æ¸…ç†sessionStorage...', 'info');
            
            try {
                const keys = Object.keys(sessionStorage);
                log(`å‘ç° ${keys.length} ä¸ªsessionStorageé”®`, 'info');
                
                sessionStorage.clear();
                
                log('sessionStorageæ¸…ç†å®Œæˆ', 'success');
                showStatus('âœ… sessionStorageå·²æ¸…ç†', 'success');
            } catch (error) {
                log(`æ¸…ç†sessionStorageå¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ sessionStorageæ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function clearIndexedDB() {
            log('å¼€å§‹æ¸…ç†IndexedDB...', 'info');
            
            try {
                if ('indexedDB' in window) {
                    const databases = await indexedDB.databases();
                    log(`å‘ç° ${databases.length} ä¸ªIndexedDBæ•°æ®åº“`, 'info');
                    
                    for (const db of databases) {
                        if (db.name) {
                            log(`åˆ é™¤IndexedDBæ•°æ®åº“: ${db.name}`, 'info');
                            const deleteRequest = indexedDB.deleteDatabase(db.name);
                            await new Promise((resolve, reject) => {
                                deleteRequest.onsuccess = () => resolve(true);
                                deleteRequest.onerror = () => reject(deleteRequest.error);
                            });
                        }
                    }
                    
                    log('IndexedDBæ¸…ç†å®Œæˆ', 'success');
                    showStatus('âœ… IndexedDBå·²æ¸…ç†', 'success');
                } else {
                    log('æµè§ˆå™¨ä¸æ”¯æŒIndexedDB', 'warning');
                    showStatus('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒIndexedDB', 'warning');
                }
            } catch (error) {
                log(`æ¸…ç†IndexedDBå¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ IndexedDBæ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function unregisterServiceWorker() {
            log('å¼€å§‹æ³¨é”€Service Worker...', 'info');
            
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`å‘ç° ${registrations.length} ä¸ªService Worker`, 'info');
                    
                    for (const registration of registrations) {
                        log(`æ³¨é”€Service Worker: ${registration.scope}`, 'info');
                        await registration.unregister();
                    }
                    
                    log('Service Workeræ³¨é”€å®Œæˆ', 'success');
                    showStatus('âœ… Service Workerå·²æ³¨é”€', 'success');
                } else {
                    log('æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'warning');
                    showStatus('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'warning');
                }
            } catch (error) {
                log(`æ³¨é”€Service Workerå¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ Service Workeræ³¨é”€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function clearAllCaches() {
            log('å¼€å§‹æ¸…ç†æ‰€æœ‰ç¼“å­˜...', 'info');
            
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`å‘ç° ${cacheNames.length} ä¸ªç¼“å­˜`, 'info');
                    
                    for (const cacheName of cacheNames) {
                        log(`åˆ é™¤ç¼“å­˜: ${cacheName}`, 'info');
                        await caches.delete(cacheName);
                    }
                    
                    log('ç¼“å­˜æ¸…ç†å®Œæˆ', 'success');
                    showStatus('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…ç†', 'success');
                } else {
                    log('æµè§ˆå™¨ä¸æ”¯æŒCache API', 'warning');
                    showStatus('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒCache API', 'warning');
                }
            } catch (error) {
                log(`æ¸…ç†ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ ç¼“å­˜æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function executeFullCleanup() {
            log('ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´æ¸…ç†æµç¨‹...', 'info');
            showStatus('ğŸš€ æ­£åœ¨æ‰§è¡Œå®Œæ•´æ¸…ç†æµç¨‹...', 'warning');
            
            try {
                // æ­¥éª¤1: æ¸…ç†localStorage
                await clearLocalStorage();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æ­¥éª¤2: æ¸…ç†sessionStorage
                await clearSessionStorage();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æ­¥éª¤3: æ¸…ç†IndexedDB
                await clearIndexedDB();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ­¥éª¤4: æ³¨é”€Service Worker
                await unregisterServiceWorker();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ­¥éª¤5: æ¸…ç†ç¼“å­˜
                await clearAllCaches();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                log('ğŸ‰ å®Œæ•´æ¸…ç†æµç¨‹æ‰§è¡Œå®Œæˆï¼', 'success');
                showStatus('ğŸ‰ å®Œæ•´æ¸…ç†æµç¨‹æ‰§è¡Œå®Œæˆï¼å‡†å¤‡åˆ·æ–°åº”ç”¨...', 'success');
                
                // å€’è®¡æ—¶åˆ·æ–°
                showCountdown(5, 'å°†åœ¨');
                setTimeout(() => {
                    window.location.href = 'http://localhost:5173';
                }, 5000);
                
            } catch (error) {
                log(`å®Œæ•´æ¸…ç†æµç¨‹å¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ å®Œæ•´æ¸…ç†æµç¨‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function manualSteps() {
            const stepsDiv = document.getElementById('manualSteps');
            stepsDiv.style.display = stepsDiv.style.display === 'none' ? 'block' : 'none';
            log('æ˜¾ç¤º/éšè—æ‰‹åŠ¨æ¸…ç†æ­¥éª¤', 'info');
        }
        
        function createFreshUser() {
            log('åˆ›å»ºå…¨æ–°ç”¨æˆ·...', 'info');
            
            try {
                const freshUser = {
                    id: 'fresh-user-' + Date.now(),
                    phone: '13800138000',
                    nickname: 'å…¨æ–°ç”¨æˆ·',
                    age: 25,
                    height: 170,
                    weight: 65,
                    fitnessGoal: 'lose_weight',
                    createdAt: new Date().toISOString()
                };
                
                const freshData = {
                    state: {
                        user: freshUser,
                        isLoggedIn: true,
                        aiCoach: null,
                        currentContract: null,
                        contractHistory: [],
                        todayCheckIns: [],
                        checkInHistory: [], // å®Œå…¨ç©ºçš„å†å²è®°å½•
                        currentChatSession: null,
                        chatHistory: [],
                        loading: false,
                        error: null
                    },
                    version: 0
                };
                
                localStorage.setItem('fitness-contract-storage', JSON.stringify(freshData));
                
                log('å…¨æ–°ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                showStatus('âœ… å…¨æ–°ç”¨æˆ·å·²åˆ›å»ºï¼Œæ²¡æœ‰ä»»ä½•å†å²æ•°æ®', 'success');
                
            } catch (error) {
                log(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function openFreshApp() {
            log('æ‰“å¼€å…¨æ–°åº”ç”¨...', 'info');
            
            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€åº”ç”¨ï¼Œå¹¶æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const timestamp = Date.now();
            const url = `http://localhost:5173?t=${timestamp}`;
            window.open(url, '_blank');
            
            log('å…¨æ–°åº”ç”¨å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€', 'success');
            showStatus('âœ… å…¨æ–°åº”ç”¨å·²æ‰“å¼€', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('å¼ºåˆ¶æ¸…ç†å·¥å…·å·²åŠ è½½', 'info');
            showStatus('ğŸ”§ å‡†å¤‡æ‰§è¡Œå½»åº•æ¸…ç†æ“ä½œ', 'info');
        };
    </script>
</body>
</html>