<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤å‘¨ä¸€è®­ç»ƒé—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .fix-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            min-width: 120px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>ğŸ”§ ä¿®å¤å‘¨ä¸€è®­ç»ƒé—®é¢˜</h1>
        
        <div id="status" class="status info">
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­å’Œä¿®å¤
        </div>
        
        <button onclick="diagnose()">ğŸ” è¯Šæ–­é—®é¢˜</button>
        <button onclick="fixMondayWorkout()">ğŸ”§ ä¿®å¤å‘¨ä¸€è®­ç»ƒ</button>
        <button onclick="createCompleteSetup()">ğŸ†• å®Œæ•´é‡ç½®</button>
        <br>
        <button onclick="goToDashboard()">ğŸ  è¿”å›ä¸»é¡µ</button>
        <button onclick="clearAll()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function diagnose() {
            updateStatus('æ­£åœ¨è¯Šæ–­...', 'info');
            
            const now = new Date();
            const dayOfWeek = now.getDay();
            const dayMapping = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayDayId = dayMapping[dayOfWeek];
            
            const userData = localStorage.getItem('app-store');
            
            if (!userData) {
                updateStatus('âŒ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œéœ€è¦é‡æ–°è®¾ç½®', 'error');
                return;
            }
            
            try {
                const parsed = JSON.parse(userData);
                const user = parsed.state?.user;
                const currentContract = parsed.state?.currentContract;
                const workoutPlan = currentContract?.workoutPlan;
                
                let issues = [];
                
                if (!user) issues.push('ç”¨æˆ·æœªç™»å½•');
                if (!currentContract) issues.push('æ²¡æœ‰å½“å‰å¥‘çº¦');
                if (!workoutPlan) issues.push('æ²¡æœ‰è®­ç»ƒè®¡åˆ’');
                
                if (workoutPlan) {
                    const selectedDays = workoutPlan.selectedDays || [];
                    if (!selectedDays.includes('monday')) {
                        issues.push('å‘¨ä¸€ä¸åœ¨è®­ç»ƒæ—¥åˆ—è¡¨ä¸­');
                    }
                }
                
                if (issues.length === 0) {
                    updateStatus(`âœ… è¯Šæ–­å®Œæˆï¼šä»Šå¤©æ˜¯${todayDayId}ï¼Œç³»ç»Ÿé…ç½®æ­£å¸¸`, 'success');
                } else {
                    updateStatus(`âŒ å‘ç°é—®é¢˜ï¼š${issues.join('ã€')}`, 'error');
                }
                
            } catch (e) {
                updateStatus(`âŒ æ•°æ®è§£æå¤±è´¥ï¼š${e.message}`, 'error');
            }
        }

        function fixMondayWorkout() {
            updateStatus('æ­£åœ¨ä¿®å¤å‘¨ä¸€è®­ç»ƒè®¾ç½®...', 'info');
            
            const userData = localStorage.getItem('app-store');
            let parsed;
            
            if (userData) {
                try {
                    parsed = JSON.parse(userData);
                } catch (e) {
                    updateStatus('âŒ æ•°æ®è§£æå¤±è´¥ï¼Œå°†åˆ›å»ºæ–°æ•°æ®', 'warning');
                    parsed = { state: {} };
                }
            } else {
                parsed = { state: {} };
            }
            
            // ç¡®ä¿ç”¨æˆ·å­˜åœ¨
            if (!parsed.state?.user) {
                parsed.state.user = {
                    id: 'user-' + Date.now(),
                    phone: '13800138000',
                    nickname: 'å¥èº«ç”¨æˆ·',
                    age: 25,
                    height: 170,
                    weight: 65,
                    fitnessGoal: 'lose_weight',
                    createdAt: new Date().toISOString(),
                    loginType: 'phone'
                };
                parsed.state.isLoggedIn = true;
            }
            
            // ç¡®ä¿å¥‘çº¦å­˜åœ¨
            if (!parsed.state.currentContract) {
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 30);
                
                parsed.state.currentContract = {
                    id: 'contract-' + Date.now(),
                    userId: parsed.state.user.id,
                    type: 'normal',
                    amount: 300,
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    status: 'active',
                    dailyTasks: ['gym', 'protein'],
                    completedDays: 0,
                    violationDays: 0,
                    remainingAmount: 300,
                    paymentStatus: 'paid',
                    violationPenalty: 100,
                    accumulatedPenalty: 0,
                    remainderAmount: 0
                };
            }
            
            // è®¾ç½®è®­ç»ƒè®¡åˆ’ï¼Œç¡®ä¿åŒ…å«å‘¨ä¸€
            parsed.state.currentContract.workoutPlan = {
                planId: 'default-plan',
                intensity: 'medium',
                goal: 'fitness',
                selectedDays: ['monday', 'tuesday', 'thursday', 'friday'],
                weeklyWorkoutDays: 4
            };
            
            // æ¸…ç©ºä»Šæ—¥æ‰“å¡è®°å½•
            parsed.state.todayCheckIns = [];
            
            // ç¡®ä¿å…¶ä»–å¿…è¦å­—æ®µå­˜åœ¨
            parsed.state.checkInHistory = parsed.state.checkInHistory || [];
            parsed.state.contractHistory = parsed.state.contractHistory || [];
            parsed.state.aiCoach = parsed.state.aiCoach || null;
            parsed.state.currentChatSession = parsed.state.currentChatSession || null;
            parsed.state.chatHistory = parsed.state.chatHistory || [];
            parsed.state.notificationSettings = parsed.state.notificationSettings || {
                enabled: true,
                frequency: 'medium',
                quietHours: { start: '22:00', end: '08:00' },
                types: {
                    checkInReminder: true,
                    checkinReminder: true,
                    contractExpiry: true,
                    aiCoachMessage: true,
                    dailyMotivation: true,
                    mealReminder: true,
                    gymReminder: true,
                    proteinReminder: true
                }
            };
            parsed.state.loading = false;
            parsed.state.error = null;
            
            try {
                localStorage.setItem('app-store', JSON.stringify(parsed));
                updateStatus('âœ… ä¿®å¤å®Œæˆï¼å‘¨ä¸€å·²è®¾ç½®ä¸ºè®­ç»ƒæ—¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'success');
            } catch (e) {
                updateStatus(`âŒ ä¿®å¤å¤±è´¥ï¼š${e.message}`, 'error');
            }
        }

        function createCompleteSetup() {
            updateStatus('æ­£åœ¨åˆ›å»ºå®Œæ•´è®¾ç½®...', 'info');
            
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            
            const completeData = {
                state: {
                    user: {
                        id: 'user-' + Date.now(),
                        phone: '13800138000',
                        nickname: 'å¥èº«è¾¾äºº',
                        age: 25,
                        height: 170,
                        weight: 65,
                        fitnessGoal: 'lose_weight',
                        createdAt: new Date().toISOString(),
                        loginType: 'phone'
                    },
                    isLoggedIn: true,
                    currentContract: {
                        id: 'contract-' + Date.now(),
                        userId: 'user-' + Date.now(),
                        type: 'normal',
                        amount: 300,
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString(),
                        status: 'active',
                        dailyTasks: ['gym', 'protein'],
                        completedDays: 0,
                        violationDays: 0,
                        remainingAmount: 300,
                        paymentStatus: 'paid',
                        violationPenalty: 100,
                        accumulatedPenalty: 0,
                        remainderAmount: 0,
                        workoutPlan: {
                            planId: 'default-plan',
                            intensity: 'medium',
                            goal: 'fitness',
                            selectedDays: ['monday', 'tuesday', 'thursday', 'friday'],
                            weeklyWorkoutDays: 4
                        }
                    },
                    contractHistory: [],
                    todayCheckIns: [],
                    checkInHistory: [],
                    aiCoach: null,
                    currentChatSession: null,
                    chatHistory: [],
                    notificationSettings: {
                        enabled: true,
                        frequency: 'medium',
                        quietHours: { start: '22:00', end: '08:00' },
                        types: {
                            checkInReminder: true,
                            checkinReminder: true,
                            contractExpiry: true,
                            aiCoachMessage: true,
                            dailyMotivation: true,
                            mealReminder: true,
                            gymReminder: true,
                            proteinReminder: true
                        }
                    },
                    loading: false,
                    error: null
                },
                version: 0
            };
            
            try {
                localStorage.setItem('app-store', JSON.stringify(completeData));
                updateStatus('âœ… å®Œæ•´è®¾ç½®åˆ›å»ºæˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢', 'success');
            } catch (e) {
                updateStatus(`âŒ åˆ›å»ºå¤±è´¥ï¼š${e.message}`, 'error');
            }
        }

        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®å’Œå¥‘çº¦ä¿¡æ¯ã€‚')) {
                localStorage.clear();
                updateStatus('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warning');
            }
        }

        function goToDashboard() {
            window.location.href = 'http://localhost:5173/';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        setTimeout(diagnose, 500);
    </script>
</body>
</html>