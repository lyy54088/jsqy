<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>周一打卡测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>周一打卡问题诊断</h1>
    
    <div class="test-section">
        <h2>当前状态检查</h2>
        <div id="currentStatus"></div>
        <button onclick="checkCurrentStatus()">检查当前状态</button>
    </div>

    <div class="test-section">
        <h2>修复操作</h2>
        <button onclick="fixMondayWorkout()">修复周一训练设置</button>
        <button onclick="createDefaultContract()">创建默认契约</button>
        <button onclick="resetWorkoutPlan()">重置训练计划</button>
        <div id="fixResults"></div>
    </div>

    <div class="test-section">
        <h2>测试结果</h2>
        <div id="testResults"></div>
    </div>

    <script>
        function checkCurrentStatus() {
            const results = [];
            
            // 检查当前时间
            const now = new Date();
            const dayOfWeek = now.getDay();
            const dayMapping = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayDayId = dayMapping[dayOfWeek];
            
            results.push(`当前时间: ${now.toLocaleString('zh-CN')}`);
            results.push(`今天是: ${todayDayId} (${dayOfWeek === 1 ? '周一' : '不是周一'})`);
            
            // 检查localStorage数据
            const userData = localStorage.getItem('app-store');
            if (!userData) {
                results.push('❌ 没有找到用户数据');
                document.getElementById('currentStatus').innerHTML = results.map(r => `<div class="result error">${r}</div>`).join('');
                return;
            }
            
            try {
                const parsed = JSON.parse(userData);
                const user = parsed.state?.user;
                const currentContract = parsed.state?.currentContract;
                
                results.push(`用户登录状态: ${user ? '✅ 已登录' : '❌ 未登录'}`);
                results.push(`当前契约: ${currentContract ? '✅ 存在' : '❌ 不存在'}`);
                
                if (currentContract) {
                    const workoutPlan = currentContract.workoutPlan;
                    results.push(`训练计划: ${workoutPlan ? '✅ 已设置' : '❌ 未设置'}`);
                    
                    if (workoutPlan) {
                        const selectedDays = workoutPlan.selectedDays || [];
                        results.push(`选择的训练日: ${selectedDays.join(', ')}`);
                        results.push(`周一是否为训练日: ${selectedDays.includes('monday') ? '✅ 是' : '❌ 否'}`);
                    } else {
                        results.push(`使用默认训练日: monday, tuesday, thursday, friday`);
                        results.push(`周一是否为训练日: ✅ 是（默认）`);
                    }
                    
                    // 检查今日是否应该能打卡
                    const selectedDays = workoutPlan?.selectedDays || ['monday', 'tuesday', 'thursday', 'friday'];
                    const isTodayWorkoutDay = selectedDays.includes(todayDayId);
                    results.push(`今日是否应该能打卡: ${isTodayWorkoutDay ? '✅ 是' : '❌ 否'}`);
                }
                
            } catch (e) {
                results.push(`❌ 解析数据失败: ${e.message}`);
            }
            
            document.getElementById('currentStatus').innerHTML = results.map(r => {
                const className = r.includes('✅') ? 'success' : r.includes('❌') ? 'error' : 'warning';
                return `<div class="result ${className}">${r}</div>`;
            }).join('');
        }

        function fixMondayWorkout() {
            const userData = localStorage.getItem('app-store');
            if (!userData) {
                document.getElementById('fixResults').innerHTML = '<div class="result error">没有找到用户数据，无法修复</div>';
                return;
            }
            
            try {
                const parsed = JSON.parse(userData);
                
                // 确保用户存在
                if (!parsed.state?.user) {
                    // 创建默认用户
                    parsed.state = parsed.state || {};
                    parsed.state.user = {
                        id: 'user-' + Date.now(),
                        phone: '13800138000',
                        nickname: '测试用户',
                        age: 25,
                        height: 170,
                        weight: 65,
                        fitnessGoal: 'lose_weight',
                        createdAt: new Date().toISOString(),
                        loginType: 'phone'
                    };
                    parsed.state.isLoggedIn = true;
                }
                
                // 确保契约存在
                if (!parsed.state.currentContract) {
                    const startDate = new Date();
                    const endDate = new Date();
                    endDate.setDate(endDate.getDate() + 30);
                    
                    parsed.state.currentContract = {
                        id: 'contract-' + Date.now(),
                        userId: parsed.state.user.id,
                        type: 'normal',
                        amount: 300,
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString(),
                        status: 'active',
                        dailyTasks: ['gym', 'protein'],
                        completedDays: 0,
                        violationDays: 0,
                        remainingAmount: 300,
                        paymentStatus: 'paid',
                        violationPenalty: 100,
                        accumulatedPenalty: 0,
                        remainderAmount: 0
                    };
                }
                
                // 设置训练计划，确保包含周一
                parsed.state.currentContract.workoutPlan = {
                    planId: 'default-plan',
                    intensity: 'medium',
                    goal: 'fitness',
                    selectedDays: ['monday', 'tuesday', 'thursday', 'friday'],
                    weeklyWorkoutDays: 4
                };
                
                // 清空今日打卡记录，重新开始
                parsed.state.todayCheckIns = [];
                
                localStorage.setItem('app-store', JSON.stringify(parsed));
                
                document.getElementById('fixResults').innerHTML = '<div class="result success">✅ 修复完成！周一已设置为训练日</div>';
                
                // 自动检查状态
                setTimeout(checkCurrentStatus, 500);
                
            } catch (e) {
                document.getElementById('fixResults').innerHTML = `<div class="result error">❌ 修复失败: ${e.message}</div>`;
            }
        }

        function createDefaultContract() {
            const userData = localStorage.getItem('app-store');
            let parsed;
            
            if (userData) {
                try {
                    parsed = JSON.parse(userData);
                } catch (e) {
                    parsed = { state: {} };
                }
            } else {
                parsed = { state: {} };
            }
            
            // 创建默认用户
            parsed.state.user = {
                id: 'user-' + Date.now(),
                phone: '13800138000',
                nickname: '测试用户',
                age: 25,
                height: 170,
                weight: 65,
                fitnessGoal: 'lose_weight',
                createdAt: new Date().toISOString(),
                loginType: 'phone'
            };
            parsed.state.isLoggedIn = true;
            
            // 创建默认契约
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            
            parsed.state.currentContract = {
                id: 'contract-' + Date.now(),
                userId: parsed.state.user.id,
                type: 'normal',
                amount: 300,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                status: 'active',
                dailyTasks: ['gym', 'protein'],
                completedDays: 0,
                violationDays: 0,
                remainingAmount: 300,
                paymentStatus: 'paid',
                violationPenalty: 100,
                accumulatedPenalty: 0,
                remainderAmount: 0,
                workoutPlan: {
                    planId: 'default-plan',
                    intensity: 'medium',
                    goal: 'fitness',
                    selectedDays: ['monday', 'tuesday', 'thursday', 'friday'],
                    weeklyWorkoutDays: 4
                }
            };
            
            // 初始化其他必要数据
            parsed.state.todayCheckIns = [];
            parsed.state.checkInHistory = [];
            parsed.state.contractHistory = [];
            parsed.state.aiCoach = null;
            parsed.state.currentChatSession = null;
            parsed.state.chatHistory = [];
            parsed.state.notificationSettings = {
                enabled: true,
                frequency: 'medium',
                quietHours: { start: '22:00', end: '08:00' },
                types: {
                    checkInReminder: true,
                    checkinReminder: true,
                    contractExpiry: true,
                    aiCoachMessage: true,
                    dailyMotivation: true,
                    mealReminder: true,
                    gymReminder: true,
                    proteinReminder: true
                }
            };
            parsed.state.loading = false;
            parsed.state.error = null;
            
            localStorage.setItem('app-store', JSON.stringify(parsed));
            
            document.getElementById('fixResults').innerHTML = '<div class="result success">✅ 默认契约创建完成！</div>';
            setTimeout(checkCurrentStatus, 500);
        }

        function resetWorkoutPlan() {
            localStorage.clear();
            document.getElementById('fixResults').innerHTML = '<div class="result warning">⚠️ 所有数据已清除</div>';
            setTimeout(checkCurrentStatus, 500);
        }

        // 页面加载时自动检查
        checkCurrentStatus();
    </script>
</body>
</html>