<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯†åˆ«ç¼“å­˜ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ AIè¯†åˆ«ç¼“å­˜ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»"æ£€æŸ¥å½“å‰ç¼“å­˜çŠ¶æ€"æŸ¥çœ‹localStorageä¸­çš„æ•°æ®</li>
                <li>ç‚¹å‡»"æ¸…ç†é—®é¢˜ç¼“å­˜"æ¸…é™¤åŒ…å«"å¾®ä¿¡"çš„å†å²è®°å½•</li>
                <li>å‰å¾€åº”ç”¨çš„æ‰“å¡é¡µé¢æµ‹è¯•ä¸Šä¼ å›¾ç‰‡</li>
                <li>éªŒè¯AIè¯†åˆ«ç»“æœæ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ” ç¼“å­˜æ£€æŸ¥</h3>
            <button onclick="checkCurrentCache()">æ£€æŸ¥å½“å‰ç¼“å­˜çŠ¶æ€</button>
            <button onclick="clearProblemCache()">æ¸…ç†é—®é¢˜ç¼“å­˜</button>
            <button onclick="clearAllCache()">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
            <div id="cacheStatus" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•ç»“æœ</h3>
            <div id="testResults" class="log">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“± å¿«é€Ÿè®¿é—®</h3>
            <button onclick="openApp()">æ‰“å¼€å¥èº«åº”ç”¨</button>
            <button onclick="openCheckIn()">ç›´æ¥æ‰“å¼€æ‰“å¡é¡µé¢</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testResults');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function checkCurrentCache() {
            const statusElement = document.getElementById('cacheStatus');
            try {
                const storageData = localStorage.getItem('fitness-contract-storage');
                if (!storageData) {
                    statusElement.textContent = 'âœ… æ²¡æœ‰æ‰¾åˆ°å¥èº«åº”ç”¨çš„ç¼“å­˜æ•°æ®';
                    statusElement.className = 'log success';
                    return;
                }

                const data = JSON.parse(storageData);
                let report = 'ğŸ“Š ç¼“å­˜æ•°æ®åˆ†æ:\n\n';
                
                // æ£€æŸ¥ä»Šæ—¥æ‰“å¡
                if (data.state?.todayCheckIns) {
                    report += `ä»Šæ—¥æ‰“å¡è®°å½•: ${data.state.todayCheckIns.length} æ¡\n`;
                    data.state.todayCheckIns.forEach((checkIn, index) => {
                        if (checkIn.aiResult && checkIn.aiResult.includes('å¾®ä¿¡')) {
                            report += `âš ï¸ å‘ç°é—®é¢˜è®°å½• #${index + 1}: ${checkIn.aiResult}\n`;
                        }
                    });
                }

                // æ£€æŸ¥å†å²æ‰“å¡
                if (data.state?.checkInHistory) {
                    report += `\nå†å²æ‰“å¡è®°å½•: ${data.state.checkInHistory.length} æ¡\n`;
                    let wechatCount = 0;
                    data.state.checkInHistory.forEach((checkIn, index) => {
                        if (checkIn.aiResult && checkIn.aiResult.includes('å¾®ä¿¡')) {
                            wechatCount++;
                            if (wechatCount <= 3) { // åªæ˜¾ç¤ºå‰3æ¡
                                report += `âš ï¸ å‘ç°é—®é¢˜è®°å½• #${index + 1}: ${checkIn.aiResult}\n`;
                            }
                        }
                    });
                    if (wechatCount > 3) {
                        report += `... è¿˜æœ‰ ${wechatCount - 3} æ¡åŒ…å«"å¾®ä¿¡"çš„è®°å½•\n`;
                    }
                }

                statusElement.textContent = report;
                statusElement.className = 'log warning';
                
            } catch (error) {
                statusElement.textContent = `âŒ æ£€æŸ¥ç¼“å­˜æ—¶å‡ºé”™: ${error.message}`;
                statusElement.className = 'log error';
            }
        }

        function clearProblemCache() {
            try {
                const storageData = localStorage.getItem('fitness-contract-storage');
                if (!storageData) {
                    log('âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„ç¼“å­˜æ•°æ®');
                    return;
                }

                const data = JSON.parse(storageData);
                let cleaned = false;

                // æ¸…ç†ä»Šæ—¥æ‰“å¡ä¸­çš„é—®é¢˜è®°å½•
                if (data.state?.todayCheckIns) {
                    const originalCount = data.state.todayCheckIns.length;
                    data.state.todayCheckIns = data.state.todayCheckIns.filter(checkIn => 
                        !checkIn.aiResult || !checkIn.aiResult.includes('å¾®ä¿¡')
                    );
                    if (data.state.todayCheckIns.length < originalCount) {
                        cleaned = true;
                        log(`ğŸ§¹ æ¸…ç†äº† ${originalCount - data.state.todayCheckIns.length} æ¡ä»Šæ—¥é—®é¢˜è®°å½•`);
                    }
                }

                // æ¸…ç†å†å²æ‰“å¡ä¸­çš„é—®é¢˜è®°å½•
                if (data.state?.checkInHistory) {
                    const originalCount = data.state.checkInHistory.length;
                    data.state.checkInHistory = data.state.checkInHistory.filter(checkIn => 
                        !checkIn.aiResult || !checkIn.aiResult.includes('å¾®ä¿¡')
                    );
                    if (data.state.checkInHistory.length < originalCount) {
                        cleaned = true;
                        log(`ğŸ§¹ æ¸…ç†äº† ${originalCount - data.state.checkInHistory.length} æ¡å†å²é—®é¢˜è®°å½•`);
                    }
                }

                if (cleaned) {
                    localStorage.setItem('fitness-contract-storage', JSON.stringify(data));
                    log('âœ… é—®é¢˜ç¼“å­˜æ¸…ç†å®Œæˆï¼');
                } else {
                    log('âœ… æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„é—®é¢˜è®°å½•');
                }

            } catch (error) {
                log(`âŒ æ¸…ç†ç¼“å­˜æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function clearAllCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¥èº«åº”ç”¨çš„ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰è®¾ç½®å’Œè®°å½•ã€‚')) {
                localStorage.removeItem('fitness-contract-storage');
                log('ğŸ—‘ï¸ æ‰€æœ‰ç¼“å­˜æ•°æ®å·²æ¸…ç©º');
            }
        }

        function openApp() {
            window.open('http://localhost:5174', '_blank');
        }

        function openCheckIn() {
            window.open('http://localhost:5174/#/checkin', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¼“å­˜
        window.onload = function() {
            log('ğŸš€ AIè¯†åˆ«ç¼“å­˜ä¿®å¤æµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            checkCurrentCache();
        };
    </script>
</body>
</html>