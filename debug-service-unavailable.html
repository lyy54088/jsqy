<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡ä¸å¯ç”¨é”™è¯¯è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .section h2 {
            color: #34495e;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .test-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .clear-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        .clear-button:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœåŠ¡ä¸å¯ç”¨é”™è¯¯è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸš€ å¿«é€Ÿè¯Šæ–­</h2>
            <button class="test-button" onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="test-button" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button class="test-button" onclick="forceReload()">å¼ºåˆ¶åˆ·æ–°</button>
            <button class="test-button" onclick="openApp()">æ‰“å¼€åº”ç”¨</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸŒ ç½‘ç»œçŠ¶æ€</h3>
                <div id="networkStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ”§ Service Worker</h3>
                <div id="swStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ’¾ æœ¬åœ°å­˜å‚¨</h3>
                <div id="storageStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ  åº”ç”¨çŠ¶æ€</h3>
                <div id="appStatus">æ£€æŸ¥ä¸­...</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ” è¯¦ç»†æ£€æŸ¥</h2>
            <button class="test-button" onclick="checkServiceWorker()">æ£€æŸ¥Service Worker</button>
            <button class="test-button" onclick="checkCache()">æ£€æŸ¥ç¼“å­˜</button>
            <button class="test-button" onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
            <button class="test-button" onclick="checkNetworkRequests()">æµ‹è¯•ç½‘ç»œè¯·æ±‚</button>
            <button class="test-button" onclick="checkConsoleErrors()">æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</button>
            <button class="test-button" onclick="checkBrowserCompatibility()">æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§</button>
        </div>

        <div class="section">
            <h2>ğŸ› ï¸ ä¿®å¤æ“ä½œ</h2>
            <button class="test-button" onclick="unregisterServiceWorker()">æ³¨é”€Service Worker</button>
            <button class="test-button" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
            <button class="test-button" onclick="resetLocalStorage()">é‡ç½®æœ¬åœ°å­˜å‚¨</button>
            <button class="test-button" onclick="hardRefresh()">ç¡¬åˆ·æ–°</button>
        </div>

        <div class="section">
            <h2>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h2>
            <button class="clear-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="logArea" class="log-area">ç­‰å¾…è¯Šæ–­...</div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('logArea');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logArea.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            logArea.innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸ”§ è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            checkBasicStatus();
        });

        async function checkBasicStatus() {
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            const networkStatus = navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿';
            document.getElementById('networkStatus').innerHTML = networkStatus;
            
            // æ£€æŸ¥Service Worker
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                const swStatus = registrations.length > 0 ? 
                    `âœ… å·²æ³¨å†Œ (${registrations.length}ä¸ª)` : 
                    'âš ï¸ æœªæ³¨å†Œ';
                document.getElementById('swStatus').innerHTML = swStatus;
            } else {
                document.getElementById('swStatus').innerHTML = 'âŒ ä¸æ”¯æŒ';
            }
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            try {
                const storageData = localStorage.getItem('fitness-contract-storage');
                const storageStatus = storageData ? 
                    `âœ… æœ‰æ•°æ® (${Math.round(storageData.length/1024)}KB)` : 
                    'âš ï¸ æ— æ•°æ®';
                document.getElementById('storageStatus').innerHTML = storageStatus;
            } catch (error) {
                document.getElementById('storageStatus').innerHTML = 'âŒ è®¿é—®å¤±è´¥';
            }
            
            // æ£€æŸ¥åº”ç”¨çŠ¶æ€
            try {
                const response = await fetch('http://localhost:5173/', { method: 'HEAD' });
                const appStatus = response.ok ? 'âœ… è¿è¡Œæ­£å¸¸' : 'âŒ å“åº”å¼‚å¸¸';
                document.getElementById('appStatus').innerHTML = appStatus;
            } catch (error) {
                document.getElementById('appStatus').innerHTML = 'âŒ è¿æ¥å¤±è´¥';
            }
        }

        async function runFullDiagnosis() {
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            clearLog();
            
            await checkServiceWorker();
            await checkCache();
            await checkLocalStorage();
            await checkNetworkRequests();
            await checkConsoleErrors();
            await checkBrowserCompatibility();
            
            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        async function checkServiceWorker() {
            log('ğŸ” æ£€æŸ¥Service Worker...', 'info');
            
            if (!('serviceWorker' in navigator)) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'error');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`ğŸ“Š å‘ç° ${registrations.length} ä¸ªService Workeræ³¨å†Œ`, 'info');
                
                for (let i = 0; i < registrations.length; i++) {
                    const reg = registrations[i];
                    log(`  - æ³¨å†Œ ${i+1}: ${reg.scope}`, 'info');
                    log(`    çŠ¶æ€: ${reg.active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}`, reg.active ? 'success' : 'warning');
                    
                    if (reg.waiting) {
                        log('    âš ï¸ æœ‰ç­‰å¾…ä¸­çš„Service Worker', 'warning');
                    }
                    
                    if (reg.installing) {
                        log('    ğŸ”„ æ­£åœ¨å®‰è£…æ–°çš„Service Worker', 'info');
                    }
                }
                
                // æ£€æŸ¥å½“å‰é¡µé¢çš„æ§åˆ¶å™¨
                if (navigator.serviceWorker.controller) {
                    log(`âœ… å½“å‰é¡µé¢ç”±Service Workeræ§åˆ¶: ${navigator.serviceWorker.controller.scriptURL}`, 'success');
                } else {
                    log('âš ï¸ å½“å‰é¡µé¢æœªè¢«Service Workeræ§åˆ¶', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Service Workeræ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkCache() {
            log('ğŸ” æ£€æŸ¥ç¼“å­˜...', 'info');
            
            if (!('caches' in window)) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒCache API', 'error');
                return;
            }
            
            try {
                const cacheNames = await caches.keys();
                log(`ğŸ“Š å‘ç° ${cacheNames.length} ä¸ªç¼“å­˜`, 'info');
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    log(`  - ${cacheName}: ${keys.length} ä¸ªç¼“å­˜é¡¹`, 'info');
                    
                    // æ£€æŸ¥ä¸»é¡µæ˜¯å¦è¢«ç¼“å­˜
                    const mainPageCached = await cache.match('/');
                    if (mainPageCached) {
                        log(`    âœ… ä¸»é¡µå·²ç¼“å­˜`, 'success');
                    } else {
                        log(`    âš ï¸ ä¸»é¡µæœªç¼“å­˜`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`âŒ ç¼“å­˜æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkLocalStorage() {
            log('ğŸ” æ£€æŸ¥æœ¬åœ°å­˜å‚¨...', 'info');
            
            try {
                // æ£€æŸ¥localStorageå¯ç”¨æ€§
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('âœ… localStorageå¯ç”¨', 'success');
                
                // æ£€æŸ¥åº”ç”¨æ•°æ®
                const storageData = localStorage.getItem('fitness-contract-storage');
                if (storageData) {
                    log(`ğŸ“Š åº”ç”¨æ•°æ®å¤§å°: ${Math.round(storageData.length/1024)}KB`, 'info');
                    
                    try {
                        const data = JSON.parse(storageData);
                        const state = data.state;
                        
                        log('ğŸ“‹ æ•°æ®ç»“æ„åˆ†æ:', 'info');
                        log(`  - ç”¨æˆ·: ${state?.user ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`, state?.user ? 'success' : 'error');
                        log(`  - ç™»å½•çŠ¶æ€: ${state?.isLoggedIn ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}`, state?.isLoggedIn ? 'success' : 'error');
                        log(`  - å¥‘çº¦: ${state?.currentContract ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`, state?.currentContract ? 'success' : 'info');
                        log(`  - AIæ•™ç»ƒ: ${state?.aiCoach ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`, state?.aiCoach ? 'success' : 'info');
                        
                        // æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
                        if (!state?.user && state?.currentContract) {
                            log('âš ï¸ æ•°æ®ä¸ä¸€è‡´: æ²¡æœ‰ç”¨æˆ·ä½†å­˜åœ¨å¥‘çº¦', 'warning');
                        }
                        
                        if (state?.currentContract?.amount === 500) {
                            log('âš ï¸ å‘ç°æµ‹è¯•æ•°æ®: 500å…ƒä¿è¯é‡‘', 'warning');
                        }
                        
                    } catch (parseError) {
                        log(`âŒ æ•°æ®è§£æå¤±è´¥: ${parseError.message}`, 'error');
                    }
                } else {
                    log('â„¹ï¸ æ²¡æœ‰åº”ç”¨æ•°æ®', 'info');
                }
                
                // æ£€æŸ¥å…¶ä»–å­˜å‚¨é¡¹
                const allKeys = Object.keys(localStorage);
                log(`ğŸ“Š localStorageæ€»å…±æœ‰ ${allKeys.length} ä¸ªé¡¹ç›®`, 'info');
                
            } catch (error) {
                log(`âŒ localStorageæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkNetworkRequests() {
            log('ğŸ” æ£€æŸ¥ç½‘ç»œè¯·æ±‚...', 'info');
            
            // æµ‹è¯•å‰ç«¯æœåŠ¡å™¨
            try {
                const frontendResponse = await fetch('http://localhost:5173/', { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                log(`âœ… å‰ç«¯æœåŠ¡å™¨å“åº”: ${frontendResponse.status}`, 'success');
            } catch (error) {
                log(`âŒ å‰ç«¯æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•åç«¯API
            try {
                const backendResponse = await fetch('http://localhost:3000/api/test', {
                    cache: 'no-cache'
                });
                if (backendResponse.ok) {
                    const data = await backendResponse.json();
                    log(`âœ… åç«¯APIå“åº”æ­£å¸¸: ${JSON.stringify(data)}`, 'success');
                } else {
                    log(`âš ï¸ åç«¯APIå“åº”å¼‚å¸¸: ${backendResponse.status}`, 'warning');
                }
            } catch (error) {
                log(`âŒ åç«¯APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•é™æ€èµ„æº
            try {
                const manifestResponse = await fetch('/manifest.json', { cache: 'no-cache' });
                log(`${manifestResponse.ok ? 'âœ…' : 'âŒ'} manifest.json: ${manifestResponse.status}`, 
                    manifestResponse.ok ? 'success' : 'error');
            } catch (error) {
                log(`âŒ manifest.jsonåŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkConsoleErrors() {
            log('ğŸ” æ£€æŸ¥æ§åˆ¶å°é”™è¯¯...', 'info');
            
            // é‡å†™console.erroræ¥æ•è·é”™è¯¯
            const originalError = console.error;
            const errors = [];
            
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            // ç›‘å¬æœªæ•è·çš„é”™è¯¯
            window.addEventListener('error', (event) => {
                log(`âŒ JavaScripté”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`, 'error');
            });
            
            window.addEventListener('unhandledrejection', (event) => {
                log(`âŒ æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
            });
            
            log('âœ… é”™è¯¯ç›‘å¬å™¨å·²è®¾ç½®', 'success');
        }

        function checkBrowserCompatibility() {
            log('ğŸ” æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...', 'info');
            
            const features = {
                'Service Worker': 'serviceWorker' in navigator,
                'Cache API': 'caches' in window,
                'Fetch API': 'fetch' in window,
                'Promise': 'Promise' in window,
                'localStorage': 'localStorage' in window,
                'sessionStorage': 'sessionStorage' in window,
                'Notification API': 'Notification' in window,
                'Web App Manifest': 'onbeforeinstallprompt' in window,
                'ES6 Modules': 'noModule' in HTMLScriptElement.prototype,
                'CSS Grid': CSS.supports('display', 'grid'),
                'CSS Flexbox': CSS.supports('display', 'flex')
            };
            
            for (const [feature, supported] of Object.entries(features)) {
                log(`  ${supported ? 'âœ…' : 'âŒ'} ${feature}`, supported ? 'success' : 'error');
            }
            
            log(`ğŸŒ ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`, 'info');
        }

        // ä¿®å¤æ“ä½œ
        async function unregisterServiceWorker() {
            log('ğŸ”§ æ³¨é”€Service Worker...', 'info');
            
            if (!('serviceWorker' in navigator)) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'error');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    log(`âœ… å·²æ³¨é”€: ${registration.scope}`, 'success');
                }
                log('âœ… æ‰€æœ‰Service Workerå·²æ³¨é”€', 'success');
            } catch (error) {
                log(`âŒ æ³¨é”€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearCache() {
            log('ğŸ”§ æ¸…é™¤ç¼“å­˜...', 'info');
            
            if (!('caches' in window)) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒCache API', 'error');
                return;
            }
            
            try {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`âœ… å·²åˆ é™¤ç¼“å­˜: ${cacheName}`, 'success');
                }
                log('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤', 'success');
            } catch (error) {
                log(`âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function resetLocalStorage() {
            log('ğŸ”§ é‡ç½®æœ¬åœ°å­˜å‚¨...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                localStorage.clear();
                log(`âœ… å·²æ¸…é™¤ ${keys.length} ä¸ªlocalStorageé¡¹ç›®`, 'success');
                
                sessionStorage.clear();
                log('âœ… å·²æ¸…é™¤sessionStorage', 'success');
            } catch (error) {
                log(`âŒ é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            log('ğŸ”§ æ¸…é™¤æ‰€æœ‰æ•°æ®...', 'info');
            resetLocalStorage();
            clearCache();
            unregisterServiceWorker();
            log('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼Œå»ºè®®åˆ·æ–°é¡µé¢', 'success');
        }

        function hardRefresh() {
            log('ğŸ”„ æ‰§è¡Œç¡¬åˆ·æ–°...', 'info');
            window.location.reload(true);
        }

        function forceReload() {
            log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°...', 'info');
            window.location.href = window.location.href + '?t=' + Date.now();
        }

        function openApp() {
            log('ğŸš€ æ‰“å¼€åº”ç”¨...', 'info');
            window.open('http://localhost:5173/', '_blank');
        }
    </script>
</body>
</html>