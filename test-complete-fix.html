<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯†åˆ«é—®é¢˜å®Œæ•´ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ AIè¯†åˆ«é—®é¢˜å®Œæ•´ä¿®å¤æµ‹è¯•</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æ‚¨éªŒè¯AIè¯†åˆ«ç¼“å­˜é—®é¢˜å’Œå›¾ç‰‡æ ¼å¼é—®é¢˜æ˜¯å¦å·²ç»ä¿®å¤ã€‚</p>
    </div>

    <div class="grid">
        <div class="container">
            <h2>ğŸ“‹ é—®é¢˜è¯Šæ–­</h2>
            
            <div class="test-section">
                <h3>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
                <button onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                <div id="systemStatus" class="log">ç­‰å¾…æ£€æŸ¥...</div>
            </div>

            <div class="test-section">
                <h3>ğŸ’¾ ç¼“å­˜æ•°æ®æ£€æŸ¥</h3>
                <button onclick="checkCacheData()">æ£€æŸ¥ç¼“å­˜æ•°æ®</button>
                <button onclick="clearProblemCache()" class="danger">æ¸…ç†é—®é¢˜ç¼“å­˜</button>
                <button onclick="clearAllCache()" class="danger">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
                <div id="cacheStatus" class="log">ç­‰å¾…æ£€æŸ¥...</div>
            </div>
        </div>

        <div class="container">
            <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            
            <div class="test-section">
                <h3>ğŸ–¼ï¸ å›¾ç‰‡æ ¼å¼æµ‹è¯•</h3>
                <input type="file" id="testImageInput" accept="image/*" style="margin-bottom: 10px;">
                <br>
                <button onclick="testImageProcessing()">æµ‹è¯•å›¾ç‰‡å¤„ç†</button>
                <button onclick="testAIRecognition()">æµ‹è¯•AIè¯†åˆ«</button>
                <div id="imageTestResult" class="log">é€‰æ‹©å›¾ç‰‡åç‚¹å‡»æµ‹è¯•...</div>
            </div>

            <div class="test-section">
                <h3>ğŸš€ å¿«é€Ÿè®¿é—®</h3>
                <button onclick="openApp()" class="success">æ‰“å¼€å¥èº«åº”ç”¨</button>
                <button onclick="openCheckIn()" class="success">ç›´æ¥æ‰“å¼€æ‰“å¡é¡µé¢</button>
                <button onclick="openDevTools()">æ‰“å¼€å¼€å‘è€…å·¥å…·</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="testResults" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testResults');
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function checkSystemStatus() {
            const statusElement = document.getElementById('systemStatus');
            statusElement.textContent = 'æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...\n';
            
            try {
                // æ£€æŸ¥å‰ç«¯æœåŠ¡
                const frontendResponse = await fetch('http://localhost:5174/');
                const frontendStatus = frontendResponse.ok;
                
                // æ£€æŸ¥åç«¯æœåŠ¡
                const backendResponse = await fetch('http://localhost:3000/health');
                const backendStatus = backendResponse.ok;
                
                let report = 'ğŸŒ ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š:\n\n';
                report += `å‰ç«¯æœåŠ¡ (5174): ${frontendStatus ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                report += `åç«¯æœåŠ¡ (3000): ${backendStatus ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n\n`;
                
                if (frontendStatus && backendStatus) {
                    report += 'ğŸ‰ æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸ï¼';
                    statusElement.className = 'log success';
                    log('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆï¼šæ‰€æœ‰æœåŠ¡æ­£å¸¸', 'success');
                } else {
                    report += 'âš ï¸ éƒ¨åˆ†æœåŠ¡å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æœåŠ¡å¯åŠ¨çŠ¶æ€';
                    statusElement.className = 'log warning';
                    log('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆï¼šéƒ¨åˆ†æœåŠ¡å¼‚å¸¸', 'warning');
                }
                
                statusElement.textContent = report;
                
            } catch (error) {
                statusElement.textContent = `âŒ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`;
                statusElement.className = 'log error';
                log(`ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkCacheData() {
            const statusElement = document.getElementById('cacheStatus');
            try {
                const storageData = localStorage.getItem('fitness-contract-storage');
                if (!storageData) {
                    statusElement.textContent = 'âœ… æ²¡æœ‰æ‰¾åˆ°å¥èº«åº”ç”¨çš„ç¼“å­˜æ•°æ®';
                    statusElement.className = 'log success';
                    log('ç¼“å­˜æ£€æŸ¥ï¼šæ²¡æœ‰å‘ç°ç¼“å­˜æ•°æ®', 'success');
                    return;
                }

                const data = JSON.parse(storageData);
                let report = 'ğŸ“Š ç¼“å­˜æ•°æ®åˆ†æ:\n\n';
                let hasProblems = false;
                
                // æ£€æŸ¥ä»Šæ—¥æ‰“å¡
                if (data.state?.todayCheckIns) {
                    report += `ä»Šæ—¥æ‰“å¡è®°å½•: ${data.state.todayCheckIns.length} æ¡\n`;
                    data.state.todayCheckIns.forEach((checkIn, index) => {
                        if (checkIn.aiResult && (checkIn.aiResult.includes('å¾®ä¿¡') || checkIn.aiResult.includes('æ”¯ä»˜'))) {
                            report += `âš ï¸ å‘ç°é—®é¢˜è®°å½• #${index + 1}: ${checkIn.aiResult.substring(0, 50)}...\n`;
                            hasProblems = true;
                        }
                    });
                }

                // æ£€æŸ¥å†å²æ‰“å¡
                if (data.state?.checkInHistory) {
                    report += `\nå†å²æ‰“å¡è®°å½•: ${data.state.checkInHistory.length} æ¡\n`;
                    let problemCount = 0;
                    data.state.checkInHistory.forEach((checkIn, index) => {
                        if (checkIn.aiResult && (checkIn.aiResult.includes('å¾®ä¿¡') || checkIn.aiResult.includes('æ”¯ä»˜'))) {
                            problemCount++;
                            if (problemCount <= 3) {
                                report += `âš ï¸ å‘ç°é—®é¢˜è®°å½• #${index + 1}: ${checkIn.aiResult.substring(0, 50)}...\n`;
                            }
                            hasProblems = true;
                        }
                    });
                    if (problemCount > 3) {
                        report += `... è¿˜æœ‰ ${problemCount - 3} æ¡åŒ…å«é—®é¢˜çš„è®°å½•\n`;
                    }
                }

                if (hasProblems) {
                    report += '\nğŸ”§ å»ºè®®ï¼šç‚¹å‡»"æ¸…ç†é—®é¢˜ç¼“å­˜"æŒ‰é’®æ¸…é™¤è¿™äº›è®°å½•';
                    statusElement.className = 'log warning';
                    log('ç¼“å­˜æ£€æŸ¥ï¼šå‘ç°é—®é¢˜è®°å½•', 'warning');
                } else {
                    report += '\nâœ… æ²¡æœ‰å‘ç°é—®é¢˜è®°å½•';
                    statusElement.className = 'log success';
                    log('ç¼“å­˜æ£€æŸ¥ï¼šæ²¡æœ‰å‘ç°é—®é¢˜è®°å½•', 'success');
                }

                statusElement.textContent = report;
                
            } catch (error) {
                statusElement.textContent = `âŒ æ£€æŸ¥ç¼“å­˜æ—¶å‡ºé”™: ${error.message}`;
                statusElement.className = 'log error';
                log(`ç¼“å­˜æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearProblemCache() {
            try {
                const storageData = localStorage.getItem('fitness-contract-storage');
                if (!storageData) {
                    log('æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„ç¼“å­˜æ•°æ®', 'info');
                    return;
                }

                const data = JSON.parse(storageData);
                let cleaned = false;

                // æ¸…ç†ä»Šæ—¥æ‰“å¡ä¸­çš„é—®é¢˜è®°å½•
                if (data.state?.todayCheckIns) {
                    const originalCount = data.state.todayCheckIns.length;
                    data.state.todayCheckIns = data.state.todayCheckIns.filter(checkIn => 
                        !checkIn.aiResult || (!checkIn.aiResult.includes('å¾®ä¿¡') && !checkIn.aiResult.includes('æ”¯ä»˜'))
                    );
                    if (data.state.todayCheckIns.length < originalCount) {
                        cleaned = true;
                        log(`æ¸…ç†äº† ${originalCount - data.state.todayCheckIns.length} æ¡ä»Šæ—¥é—®é¢˜è®°å½•`, 'success');
                    }
                }

                // æ¸…ç†å†å²æ‰“å¡ä¸­çš„é—®é¢˜è®°å½•
                if (data.state?.checkInHistory) {
                    const originalCount = data.state.checkInHistory.length;
                    data.state.checkInHistory = data.state.checkInHistory.filter(checkIn => 
                        !checkIn.aiResult || (!checkIn.aiResult.includes('å¾®ä¿¡') && !checkIn.aiResult.includes('æ”¯ä»˜'))
                    );
                    if (data.state.checkInHistory.length < originalCount) {
                        cleaned = true;
                        log(`æ¸…ç†äº† ${originalCount - data.state.checkInHistory.length} æ¡å†å²é—®é¢˜è®°å½•`, 'success');
                    }
                }

                if (cleaned) {
                    localStorage.setItem('fitness-contract-storage', JSON.stringify(data));
                    log('é—®é¢˜ç¼“å­˜æ¸…ç†å®Œæˆï¼', 'success');
                    checkCacheData(); // é‡æ–°æ£€æŸ¥
                } else {
                    log('æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„é—®é¢˜è®°å½•', 'info');
                }

            } catch (error) {
                log(`æ¸…ç†ç¼“å­˜æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function clearAllCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¥èº«åº”ç”¨çš„ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰è®¾ç½®å’Œè®°å½•ã€‚')) {
                localStorage.removeItem('fitness-contract-storage');
                log('æ‰€æœ‰ç¼“å­˜æ•°æ®å·²æ¸…ç©º', 'warning');
                checkCacheData(); // é‡æ–°æ£€æŸ¥
            }
        }

        async function testImageProcessing() {
            const fileInput = document.getElementById('testImageInput');
            const resultElement = document.getElementById('imageTestResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultElement.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡';
                return;
            }

            const file = fileInput.files[0];
            resultElement.textContent = `æ­£åœ¨æµ‹è¯•å›¾ç‰‡å¤„ç†...\næ–‡ä»¶: ${file.name}\nå¤§å°: ${file.size} bytes\nç±»å‹: ${file.type}\n\n`;

            try {
                // æ¨¡æ‹Ÿå‰ç«¯çš„å›¾ç‰‡å¤„ç†é€»è¾‘
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    try {
                        // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                        const maxSize = 1024;
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUri = canvas.toDataURL('image/jpeg', 0.8);
                        
                        resultElement.textContent += `âœ… å›¾ç‰‡å¤„ç†æˆåŠŸ!\n`;
                        resultElement.textContent += `åŸå§‹å°ºå¯¸: ${img.width}x${img.height}\n`;
                        resultElement.textContent += `å‹ç¼©å°ºå¯¸: ${width}x${height}\n`;
                        resultElement.textContent += `Data URI é•¿åº¦: ${dataUri.length} å­—ç¬¦\n`;
                        resultElement.textContent += `å‹ç¼©ç‡: ${((1 - dataUri.length / (file.size * 1.37)) * 100).toFixed(1)}%\n`;
                        
                        log(`å›¾ç‰‡å¤„ç†æµ‹è¯•æˆåŠŸ: ${file.name}`, 'success');
                        
                    } catch (error) {
                        resultElement.textContent += `âŒ å›¾ç‰‡å¤„ç†å¤±è´¥: ${error.message}`;
                        log(`å›¾ç‰‡å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                img.onerror = () => {
                    resultElement.textContent += 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥';
                    log('å›¾ç‰‡å¤„ç†æµ‹è¯•å¤±è´¥: å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                };
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                resultElement.textContent += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                log(`å›¾ç‰‡å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAIRecognition() {
            const fileInput = document.getElementById('testImageInput');
            const resultElement = document.getElementById('imageTestResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultElement.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡';
                return;
            }

            const file = fileInput.files[0];
            resultElement.textContent += `\næ­£åœ¨æµ‹è¯•AIè¯†åˆ«...\n`;

            try {
                // å¤„ç†å›¾ç‰‡
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = async () => {
                    try {
                        const maxSize = 1024;
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUri = canvas.toDataURL('image/jpeg', 0.8);
                        
                        // è°ƒç”¨åç«¯API
                        const response = await fetch('http://localhost:3000/api/vision/analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                imageUrl: dataUri,
                                prompt: 'è¿™æ˜¯ä¸€å¼ é£Ÿç‰©ç…§ç‰‡ï¼Œè¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„é£Ÿç‰©ç§ç±»ã€è¥å…»æˆåˆ†å’Œå¤§æ¦‚çš„å¡è·¯é‡Œå«é‡ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå¹¶å°½é‡æä¾›è¯¦ç»†çš„è¥å…»ä¿¡æ¯ã€‚'
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            resultElement.textContent += `âœ… AIè¯†åˆ«æˆåŠŸ!\n`;
                            resultElement.textContent += `è¯†åˆ«ç»“æœ: ${result.data?.description || 'æ— ç»“æœ'}\n`;
                            log(`AIè¯†åˆ«æµ‹è¯•æˆåŠŸ: ${file.name}`, 'success');
                        } else {
                            const errorText = await response.text();
                            resultElement.textContent += `âŒ AIè¯†åˆ«å¤±è´¥: ${response.status} ${errorText}\n`;
                            log(`AIè¯†åˆ«æµ‹è¯•å¤±è´¥: ${response.status} ${errorText}`, 'error');
                        }
                        
                    } catch (error) {
                        resultElement.textContent += `âŒ AIè¯†åˆ«å¤±è´¥: ${error.message}\n`;
                        log(`AIè¯†åˆ«æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                resultElement.textContent += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                log(`AIè¯†åˆ«æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function openApp() {
            window.open('http://localhost:5174', '_blank');
        }

        function openCheckIn() {
            window.open('http://localhost:5174/#/checkin', '_blank');
        }

        function openDevTools() {
            alert('è¯·æŒ‰ F12 æˆ–å³é”®é€‰æ‹©"æ£€æŸ¥"æ¥æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œç„¶åæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('AIè¯†åˆ«é—®é¢˜å®Œæ•´ä¿®å¤æµ‹è¯•å·¥å…·å·²å¯åŠ¨', 'info');
            checkSystemStatus();
            checkCacheData();
        };
    </script>
</body>
</html>